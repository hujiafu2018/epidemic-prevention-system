<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>进入预登记</title>
    <link rel="stylesheet" href="./css/file.css">
    <link rel="stylesheet" href="js/need/layer.css?2.0">
    <link rel="stylesheet" href="./css/common.css">
    <link rel="stylesheet" type="text/css" href="./css/out_register.css"/>
    <script src="js/jquery.min.js"></script>
    <script src="./js/rem.js"></script>
    <script src="./js/layer.js"></script>
    <script src="./js/http.js"></script>
    <script src="./js/imgUp.js"></script>
    <script src="./js/testData.js"></script>
    <script type="text/javascript">

        document.addEventListener('plusready', function(){
            //console.log("所有plus api都应该在此事件发生后调用，否则会出现plus is undefined。"

        });

    </script>
    <style>
        input[type="date"]:before{
            content:attr(placeholder);
            color:#ccc
        }
        select{
            width:100%;
            background:none;appearance:none;-moz-appearance:none;-webkit-appearance:none;
            outline: none;
            border:none;
            font-size:0.3rem;
            color:#666666;
            padding:0.7rem 0 0.27rem;
            border-bottom: 1px solid #f5f5f5;
        }
        .layui-m-anim-up{
            overflow:scroll;
        }
        .label_icons{
            border:1px solid #333333;
            color:#666666;
            padding:0.05rem 0;
            border-radius: 0.08rem;
            font-size:0.3rem;
            margin-left:0.2rem;
            margin-bottom:0.2rem;
            width:2rem;
            text-align: center;
            float: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .label_icons:last-child{
            margin-bottom:0;
        }
        .setColor{
            background:rgba(71,144,253,1);
            color:#ffffff;
        }
    </style>
</head>
<body>
<div class="isShow">
    <!--个人基本信息-->
    <div class="d_person">
        <div class="d_person_title">
            <label></label>
            <span>个人基本信息</span>
        </div>
        <div class="d_item">
            <div class="d_item_labels">
                <label>
                    <i>*</i>
                    <text>姓名</text>
                </label>
                <div class="d_camera">
                    <img src="./img/icon_camera.png" alt="">
                    <text>扫描身份证自动填写</text>
                    <input accept="image/*"  id="filePic" type="file" class="files">
                </div>
            </div>
            <div class="d_item_input">
                <input id="user_name" maxlength="5" type="text" placeholder="请输入您的姓名">
            </div>
        </div>
        <div class="d_item">
            <div class="d_item_labels">
                <label>
                    <i>*</i>
                    <text>身份证号</text>
                </label>
            </div>
            <div class="d_item_input">
                <input id="user_idcard" maxlength="19" type="text" placeholder="请输入您的身份证号码">
            </div>
        </div>
        <div class="d_item">
            <div class="d_item_labels">
                <label>
                    <i>*</i>
                    <text>身份证地址</text>
                </label>
            </div>
            <div class="d_item_input">
                <input id="user_address" type="text" placeholder="请输入您的身份证地址">
            </div>
        </div>
        <div class="d_item">
            <div class="d_item_labels">
                <label>
                    <i>*</i>
                    <text>手机号码</text>
                </label>
            </div>
            <div class="d_item_input">
                <input id="user_phone" maxlength="11" type="text" placeholder="请输入您的手机号码">
            </div>
        </div>
        <div class="d_item">
            <div class="d_item_labels">
                <label>
                    <i>*</i>
                    <text>现居住地址</text>
                </label>
            </div>
            <div class="d_item_input">
                <!-- <input id="user_nowAddress" style="border-bottom: 0;" type="text" placeholder="请输入您的现居住地址"> -->
                <input onclick="clickMenu()" type="text" id="user_nowAddress" readonly="readonly" placeholder="请选择您的现居住地址">
            </div>
        </div>
    </div>
    <!--行踪登记-->
    <div class="d_person">
        <div class="d_person_title">
            <label></label>
            <span>行踪登记</span>
        </div>
        <div class="d_item">
            <div class="d_item_labels">
                <label>
                    <i>*</i>
                    <text>来村时间</text>
                </label>
            </div>
            <div class="d_item_input">
                <input id="user_time" style="width:100%;background:none;appearance:none;-moz-appearance:none;-webkit-appearance:none;" type="date" placeholder="请选择来村时间">
            </div>
        </div>
        <div class="d_item">
            <div class="d_item_labels">
                <label>
                    <i>*</i>
                    <text>起点（从哪儿来）</text>
                </label>
            </div>
            <div class="d_item_input">
                <input id="user_startAddress" type="text" placeholder="请输入文字说明，如：合川区沙鱼镇">
            </div>
        </div>
        <div class="d_item">
            <div class="d_item_labels">
                <label>
                    <i>*</i>
                    <text>交通方式（怎么来）</text>
                </label>
            </div>
            <div class="d_item_input">
                <select id="user_transportation">
                    <option value ="">请选择交通方式</option>
                    <option value ="火车/动车/高铁">火车/动车/高铁</option>
                    <option value ="自驾">自驾</option>
                    <option value ="飞机">飞机</option>
                    <option value ="客车">客车</option>
                </select>
                <!-- <input id="user_transportation"  type="text" placeholder="请输入文字说明，如自驾、轻轨、飞机、汽车等"> -->
            </div>
        </div>
        <div class="d_item">
            <div class="d_item_labels">
                <label>
                    <i>*</i>
                    <text>来往事由（来做什么）</text>
                </label>
            </div>
            <!-- <div class="d_item_input">
                <input id="user_reason" style="border-bottom: 0;" type="text" placeholder="请输入文字说明，如打工、探亲等">
            </div> -->
            <div class="d_item">
                <div class="d_item_selecteds" onclick="checkWork(this)" style="padding-top:0">
                    <img src="./img/icon_check.png" alt="" class="selected_img">
                    <text>工作</text>
                </div>
                <div class="d_item_selecteds" onclick="checkWork(this)">
                    <img src="./img/icon_check.png" alt="" class="selected_img">
                    <text>上学</text>
                </div>
                <div class="d_item_selecteds" onclick="checkWork(this)">
                    <img src="./img/icon_check.png" alt="" class="selected_img">
                    <text>探亲</text>
                </div>
                <div class="d_item_selecteds" onclick="checkWork(this)">
                    <img src="./img/icon_check.png" alt="" class="selected_img">
                    <text>回家</text>
                </div>
                <div class="d_item_selecteds" onclick="checkWork(this)">
                    <img src="./img/icon_check.png" alt="" class="selected_img">
                    <text>出差</text>
                </div>
                <div class="d_item_selecteds" onclick="checkWork(this)">
                    <img src="./img/icon_check.png" alt="" class="selected_img">
                    <text>施工</text>
                </div>
                <div class="d_item_selecteds" onclick="checkWork(this)">
                    <img src="./img/icon_check.png" alt="" class="selected_img">
                    <text>其他</text>
                </div>
            </div>
        </div>
    </div>
    <!--当前身体状况-->
    <div class="d_person">
        <div class="d_person_title">
            <label></label>
            <span>当前身体状况（必填）</span>
        </div>
        <div class="d_item">
            <div class="d_item_selected" onclick="selected(this,0)" style="padding-top:0">
                <img src="./img/icon_check.png" alt="" class="selected_img">
                <text>正常</text>
            </div>
            <div class="d_item_selected" onclick="selected(this,1)">
                <img src="./img/icon_check.png" alt="" class="selected_img">
                <text>最近有发烧、咳嗽、流涕等症状</text>
            </div>
            <div class="d_item_selected" onclick="selected(this,2)">
                <img src="./img/icon_check.png" alt="" class="selected_img">
                <text>其他</text>
            </div>
        </div>
    </div>
    <!--行踪登记-->
    <div class="d_person">
        <div class="d_person_title">
            <label></label>
            <span>租户信息</span>
        </div>
        <div class="d_item">
            <div class="d_item_labels">
                <label>
                    <text>房东姓名（或公司）</text>
                </label>
            </div>
            <div class="d_item_input">
                <input id="user_landlady"  type="text" placeholder="请输入房东姓名或公司">
            </div>
        </div>
        <div class="d_item">
            <div class="d_item_labels">
                <label>
                    <text>手机号码</text>
                </label>
            </div>
            <div class="d_item_input">
                <input id="user_landlady_phone" maxlength="11"  type="text" placeholder="请输入房东的联系电话">
            </div>
        </div>
    </div>
    <!--上传证明资料-->
    <div style="background:#ffffff;">
        <div class="d_person" style="min-height:">
            <div class="d_person_title">
                <label></label>
                <span>请上传健康证明（选填 <em class="picLength">0</em>/9）</span>
            </div>
            <div class="d_item d_line" style="margin-top:0">
                <!-- <div class="d_pic_item">
                    <img src="./img/icon_add_photo.png" alt="" class="ic_add_pic">
                    <input type="file" class="d_item_file">
                </div>
                <div class="d_pic_item">
                    <img src="./img/icon_add_photo.png" alt="" class="ic_add_pic">
                    <img src="./img/icon_close.png" alt="" class="ic_close">
                </div> -->
                <div class="img-box full">
                    <section class=" img-section">
                        <!-- <p class="up-p">作品图片：<span class="up-span">最多可以上传5张图片，马上上传</span></p> -->
                        <div class="z_photo upimg-div clear" >
                            <!--<section class="up-section fl">
                                 <span class="up-span"></span>
                                 <img src="/img/buyerCenter/a7.png" class="close-upimg">
                                 <img src="/img/buyerCenter/3c.png" class="type-upimg" alt="添加标签">
                                 <img src="/img/test2.jpg" class="up-img">
                                 <p class="img-namep"></p>
                                 <input id="taglocation" name="taglocation" value="" type="hidden">
                                 <input id="tags" name="tags" value="" type="hidden">
                             </section>-->
                            <section class="z_file fl">
                                <img src="img/icon_add_photo.png" class="add-img">
                                <input type="file" name="file" id="file" class="file" value="" accept="image/*" multiple  />
                            </section>
                        </div>
                    </section>
                </div>
                <aside class="mask works-mask">
                    <div class="mask-content">
                        <p class="del-p ">您确定要删除图片吗？</p>
                        <p class="check-p"><span class="del-com wsdel-ok">确定</span><span class="wsdel-no">取消</span></p>
                    </div>
                </aside>
            </div>
        </div>

        <!--提交-->
        <div class="btn_submit" >
            <button onclick="submitForm()">提交</button>
        </div>
    </div>
</div>
<!--登记成功-->
<div class="show_success" style="display: none;">
    <img src="./img/icon_success.png" alt="">
    <div style="font-size:0.36rem;color:#333333;">提交成功</div>
</div>
</body>
<script>
    var sex="";
    $('input').on('blur', function () {
        setTimeout(function(){
            var scrollHeight = document.documentElement.scrollTop || document.body.scrollTop || 0;
            window.scrollTo(0, Math.max(scrollHeight - 1, 0));
        }, 100);
    });

    //打开弹窗
    var get_address_id="";//获取到的社区Id
    var get_address_name="";//获取到的社区name
    var htmls=""//定义html
    var modelayer="";//关闭弹框
    function clickMenu(){
        modelayer=layer.open({
            type: 1
            ,content: htmls
            ,anim: 'up'
            ,style: 'position:fixed; bottom:0; left:0; width: 100%; height: 223px; padding:10px 0; border:none;'
        });
    };

    //点击获取社区id
    function getAddressId(obj,id){
        $("#user_nowAddress").val($(obj).text());
        $(obj).addClass('setColor').siblings().removeClass("setColor")
        layer.close(modelayer)
        get_address_name = $(obj).text();
    }

    function selectAddress(arr){
        var hgS3=new selectSwiper({
            el:'.select_box3',
            mustSelect:true,
            activeIndex:0,
            data:arr,
            init:function(index){
                if(index!==-1){
                    $('.btn3').val(this.data[index]);
                }
            },
            okFunUndefind:function(){
                alert('必须选择一项');return false;
            },
            okFun:function(index){
                $('.btn3').val(this.data[index]);
            },
            closeFun:function(){
                console.log('取消');
            },
        });
        $('.btn3').on('click',function(){hgS3.openSelectSwiper();});
    }




    //扫描识别
    window.onload = function() {
        // 获取input:file标签
        let file = document.getElementById("filePic");
        // 注册改变事件
        file.onchange = () => {
            // 获取里面上传的内容 -> 返回的是一个伪数组
            let fileData = file.files[0];
            // window.URL 有兼容问题
            // 兼容代码
            const windowURL = window.URL || window.webkitURL;
            // window.URL.createObjectURL 会根据传入的参数创建一个指向该参数对象的URL
            let imgSrc = windowURL.createObjectURL(fileData);
            // 设置imgsrc
            // document.querySelector("#img").setAttribute("src", imgSrc)
            uploadFile(fileData)
        };

        //获取所属社
        sendAjax(business_community_fun,"","get",function(res){
            if(res.code == 200){
                var data = res.rows;
                for(var i = 0; i < data.length; i++){
                    htmls+='<div class="label_icons" onclick="getAddressId(this,'+data[i].id+')">'+data[i].name+'</div>'
                }
            }
        })
    };


    //上传图片
    function uploadFile(file){
        var loading=layer.open({
            type: 2,
            content: '识别中...',
            shadeClose: false,
        });
        var data = new FormData();
        // data.append("path", opt.formData.path);
        data.append("file", file);
        $.ajax({
            type : 'POST',
            url : host+sacan_file_fun,
            data : data,
            processData : false,
            contentType : false,
            dataType : 'json',
            success : function(res) {
                // console.log(res);
                var result=JSON.parse(res)
                layer.close(loading)
                $("#user_name").val(result.data.realname);//姓名
                $("#user_idcard").val(result.data.id_card);//身份证号码
                $("#user_address").val(result.data.id_card_address);//身份证地址
                sex=result.data.sex;
            },
            error : function(e) {
                layer.close(loading)
            }
        });
    }


    //来村时间
    var a=document.getElementById("user_time");
    a.onfocus=function(){
        this.removeAttribute('placeholder')
    }
    a.onblur=function(){
        if(this.value==""){
            this.setAttribute('placeholder','请选择来村时间')
        }
    }


    //点击选择身体状况
    var selected_num="";//身体状况
    function selected(obj,num){
        $(".d_item_selected").find(".selected_img").attr("src","./img/icon_check.png")
        $(obj).find(".selected_img").attr("src","./img/icon_cheked.png")
        selected_num=num;
    };


    var user_reason="";//来往事由
    function checkWork(obj,num){
        $(".d_item_selecteds").find(".selected_img").attr("src","./img/icon_check.png")
        $(obj).find(".selected_img").attr("src","./img/icon_cheked.png")
        user_reason= $($(obj).children()[1]).html();
    };


    //提交
    function submitForm(){
        //姓名
        var user_name=$("#user_name").val();
        if(user_name==""){
            layer.open({
                content: '信息未填写完整',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return;
        };
        //身份证号码
        var user_idcard=$("#user_idcard").val();
        if(user_idcard==""){
            layer.open({
                content: '信息未填写完整',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return;
        };
        var reg=/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
        if(reg.test(user_idcard)==false){
            layer.open({
                content: '请输入有效合法的身份证号！',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return false;
        }
        //身份证地址
        var user_address=$("#user_address").val();
        if(user_address==""){
            layer.open({
                content: '信息未填写完整',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return;
        };
        //手机号码
        var user_phone=$("#user_phone").val();
        if(user_phone==""){
            layer.open({
                content: '信息未填写完整',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return;
        };
        if(!(/^1[3456789]\d{9}$/.test(user_phone))){
            layer.open({
                content: '手机号码有误',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return false;
        }
        //现居住地址
        var user_nowAddress=get_address_name;
        if(user_nowAddress==""){
            layer.open({
                content: '信息未填写完整',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return;
        };
        //来往时间
        var user_time=$("#user_time").val();
        if(user_time==""){
            layer.open({
                content: '信息未填写完整',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return;
        };
        //起点
        var user_startAddress=$("#user_startAddress").val();
        if(user_startAddress==""){
            layer.open({
                content: '信息未填写完整',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return;
        };
        //交通方式
        var user_transportation=$("#user_transportation").val();
        if(user_transportation==""){
            layer.open({
                content: '信息未填写完整',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return;
        };
        //来往事由
        // var user_reason=$("#user_reason").val();
        if(user_reason==""){
            layer.open({
                content: '信息未填写完整',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return;
        };

        //当前身体状况
        if(selected_num.toString()==""){
            layer.open({
                content: '信息未填写完整',
                skin: 'msg',
                time: 2 //2秒后自动关闭
            });
            return;
        }

        //房东姓名
        var user_landlady=$("#user_landlady").val();

        //房东电话
        var user_landlady_phone=$("#user_landlady_phone").val();


        //遍历拿到图片Id
        var certId="";
        $('.z_photo .up-section').each(function(i){                   // 遍历 tr
            certId+=$(this).attr("data-id")+','
        });
        certId=certId.substring(0,certId.length-1)

        var loading=layer.open({
            type: 2,
            content: '提交中...',
            shadeClose: false,
        });
        //请求数据
        var data={
            name:user_name,//真实姓名
            idCard:user_idcard,//身份证号码
            cardAddress:user_address,//身份证地址
            phoneNumber:user_phone,//手机号码
            livingAdress:user_nowAddress,//现居住地址
            comeTime:user_time,//来往时间
            startAction:user_startAddress,//起点
            modelOfTransportation:user_transportation,//交通方式
            comeCause:user_reason,//来往事由
            physicalCondition:selected_num,//身体状况
            tenantsInformationCompany:user_landlady,//房东姓名
            tenantsInformationPhone:user_landlady_phone,//房东电话
            healthCertificateFile:certId,//证明材料，图片id,英文逗号分割，例：3,4,5
            sex:sex
        }
        sendAjax(in_submit_fun,JSON.stringify(data),'post',function(res){
            if(res.code == 200){
                setTimeout(function(){
                    layer.close(loading)
                    $(".isShow").hide();
                    $(".show_success").show();
                },1000)
            }else{
                layer.open({
                    content: res.msg,
                    skin: 'msg',
                    time: 2 //2秒后自动关闭
                });
                setTimeout(function(){
                    layer.close(loading)
                },1000)
            }
        })

    }
</script>
</html>